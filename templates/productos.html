<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Productos - Sistema de Inventario</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #212529;
            --border-color: #dee2e6;
            --card-bg: #ffffff;
        }

        [data-theme="dark"] {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --text-primary: #e9ecef;
            --border-color: #495057;
            --card-bg: #2d2d2d;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .card {
            background-color: var(--card-bg);
            border-color: var(--border-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .table {
            color: var(--text-primary);
        }

        .badge-stock-low { background-color: #dc3545; }
        .badge-stock-ok { background-color: #28a745; }
        .badge-stock-medium { background-color: #ffc107; color: #000; }

        .producto-activo { opacity: 1; }
        .producto-inactivo { opacity: 0.5; text-decoration: line-through; }

        .btn-action { margin: 0 2px; }

        .search-box {
            max-width: 400px;
        }

        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9998;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-box-seam"></i> Sistema de Inventario
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="bi bi-boxes"></i> Productos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="verAlertas()">
                            <i class="bi bi-exclamation-triangle"></i> Alertas
                            <span class="badge bg-danger" id="alertasBadge" style="display:none;">0</span>
                        </a>
                    </li>
                </ul>
                <div class="navbar-nav">
                    <span class="navbar-text me-3" id="userInfo"></span>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">
                        <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header con búsqueda y botones -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="bi bi-boxes"></i> Gestión de Productos</h2>
                <p class="text-muted mb-0">Administra el inventario de productos</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" onclick="abrirModalCrear()" id="btnCrear">
                    <i class="bi bi-plus-circle"></i> Nuevo Producto
                </button>
                <button class="btn btn-outline-secondary" onclick="cargarProductos()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>

        <!-- Filtros y búsqueda -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="searchInput" 
                                   placeholder="Buscar por código o nombre..." 
                                   onkeyup="filtrarProductos()">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filtroEstado" onchange="filtrarProductos()">
                            <option value="todos">Todos los estados</option>
                            <option value="activo" selected>Solo activos</option>
                            <option value="inactivo">Solo inactivos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filtroCategoria" onchange="filtrarProductos()">
                            <option value="">Todas las categorías</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-danger w-100" onclick="limpiarFiltros()">
                            <i class="bi bi-x-circle"></i> Limpiar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de productos -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="tablaProductos">
                        <thead class="table-dark">
                            <tr>
                                <th>Código</th>
                                <th>Nombre</th>
                                <th>Categoría</th>
                                <th>Stock</th>
                                <th>Estado Stock</th>
                                <th>Unidad</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productosTableBody">
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Crear/Editar Producto -->
    <div class="modal fade" id="modalProducto" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalProductoTitle">Nuevo Producto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formProducto">
                        <input type="hidden" id="productoId">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Código <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="productoCodigo" required>
                                <div class="form-text">Código único del producto</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Nombre <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="productoNombre" required>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">Descripción</label>
                                <textarea class="form-control" id="productoDescripcion" rows="2"></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Categoría</label>
                                <input type="text" class="form-control" id="productoCategoria" 
                                       list="categoriasList">
                                <datalist id="categoriasList"></datalist>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Unidad <span class="text-danger">*</span></label>
                                <select class="form-select" id="productoUnidad" required>
                                    <option value="pz">Pieza (pz)</option>
                                    <option value="kg">Kilogramo (kg)</option>
                                    <option value="lt">Litro (lt)</option>
                                    <option value="mt">Metro (mt)</option>
                                    <option value="caja">Caja</option>
                                    <option value="paquete">Paquete</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Stock Mínimo</label>
                                <input type="number" class="form-control" id="productoStockMinimo" 
                                       value="0" min="0">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Stock Actual</label>
                                <input type="number" class="form-control" id="productoStockActual" 
                                       value="0" min="0">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarProducto()">
                        <i class="bi bi-save"></i> Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay y spinner -->
    <div class="overlay" id="overlay"></div>
    <div class="loading-spinner">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuración
        const API_URL = '/api';
        let productos = [];
        let productosFiltrados = [];
        let modalProducto;

        // Verificar autenticación al cargar
        window.addEventListener('DOMContentLoaded', () => {
            verificarAutenticacion();
            modalProducto = new bootstrap.Modal(document.getElementById('modalProducto'));
        });

        // Verificar token JWT
        async function verificarAutenticacion() {
            const token = localStorage.getItem('token');
            
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/auth/verify-token`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('Token inválido');
                }

                const data = await response.json();
                document.getElementById('userInfo').textContent = 
                    `${data.user.nombre} (${data.user.rol})`;
                
                // Cargar productos
                await cargarProductos();
                await verificarAlertas();
                
            } catch (error) {
                console.error('Error de autenticación:', error);
                localStorage.removeItem('token');
                window.location.href = '/login';
            }
        }

        // Cargar productos desde la API
        async function cargarProductos() {
            mostrarLoading(true);
            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${API_URL}/productos/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Error al cargar productos');

                productos = await response.json();
                productosFiltrados = [...productos];
                renderizarTabla();
                cargarCategorias();
                
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al cargar productos', 'danger');
            } finally {
                mostrarLoading(false);
            }
        }

        // Renderizar tabla
        function renderizarTabla() {
            const tbody = document.getElementById('productosTableBody');
            
            if (productosFiltrados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">No se encontraron productos</td>
                    </tr>`;
                return;
            }

            tbody.innerHTML = productosFiltrados.map(p => {
                const stockClass = p.Stock_Actual === 0 ? 'badge-stock-low' :
                                  p.Stock_Actual <= p.Stock_Minimo ? 'badge-stock-medium' :
                                  'badge-stock-ok';
                const stockText = p.Stock_Actual === 0 ? 'Agotado' :
                                 p.Stock_Actual <= p.Stock_Minimo ? 'Bajo' : 'Normal';
                
                return `
                    <tr class="${p.Activo ? 'producto-activo' : 'producto-inactivo'}">
                        <td><strong>${p.Codigo}</strong></td>
                        <td>${p.Nombre}</td>
                        <td>${p.Categoria || '-'}</td>
                        <td>
                            <strong>${p.Stock_Actual}</strong> / ${p.Stock_Minimo}
                        </td>
                        <td>
                            <span class="badge ${stockClass}">${stockText}</span>
                        </td>
                        <td>${p.Unidad}</td>
                        <td>
                            <span class="badge ${p.Activo ? 'bg-success' : 'bg-secondary'}">
                                ${p.Activo ? 'Activo' : 'Inactivo'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info btn-action" 
                                    onclick="verDetalle(${p.ID_Producto})"
                                    title="Ver detalle">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning btn-action" 
                                    onclick="abrirModalEditar(${p.ID_Producto})"
                                    title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger btn-action" 
                                    onclick="eliminarProducto(${p.ID_Producto})"
                                    title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>`;
            }).join('');
        }

        // Filtrar productos
        function filtrarProductos() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const estado = document.getElementById('filtroEstado').value;
            const categoria = document.getElementById('filtroCategoria').value;

            productosFiltrados = productos.filter(p => {
                const matchSearch = !searchTerm || 
                                   p.Codigo.toLowerCase().includes(searchTerm) ||
                                   p.Nombre.toLowerCase().includes(searchTerm);
                
                const matchEstado = estado === 'todos' || 
                                   (estado === 'activo' && p.Activo) ||
                                   (estado === 'inactivo' && !p.Activo);
                
                const matchCategoria = !categoria || p.Categoria === categoria;

                return matchSearch && matchEstado && matchCategoria;
            });

            renderizarTabla();
        }

        // Cargar categorías para filtro
        function cargarCategorias() {
            const categorias = [...new Set(productos.map(p => p.Categoria).filter(Boolean))];
            const select = document.getElementById('filtroCategoria');
            const datalist = document.getElementById('categoriasList');
            
            select.innerHTML = '<option value="">Todas las categorías</option>';
            datalist.innerHTML = '';
            
            categorias.forEach(cat => {
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
                datalist.innerHTML += `<option value="${cat}">`;
            });
        }

        // Abrir modal para crear
        function abrirModalCrear() {
            document.getElementById('formProducto').reset();
            document.getElementById('productoId').value = '';
            document.getElementById('modalProductoTitle').textContent = 'Nuevo Producto';
            modalProducto.show();
        }

        // Abrir modal para editar
        async function abrirModalEditar(id) {
            const producto = productos.find(p => p.ID_Producto === id);
            if (!producto) return;

            document.getElementById('productoId').value = producto.ID_Producto;
            document.getElementById('productoCodigo').value = producto.Codigo;
            document.getElementById('productoNombre').value = producto.Nombre;
            document.getElementById('productoDescripcion').value = producto.Descripcion || '';
            document.getElementById('productoCategoria').value = producto.Categoria || '';
            document.getElementById('productoUnidad').value = producto.Unidad;
            document.getElementById('productoStockMinimo').value = producto.Stock_Minimo;
            document.getElementById('productoStockActual').value = producto.Stock_Actual;
            
            document.getElementById('modalProductoTitle').textContent = 'Editar Producto';
            modalProducto.show();
        }

        // Guardar producto (crear o editar)
        async function guardarProducto() {
            const form = document.getElementById('formProducto');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const id = document.getElementById('productoId').value;
            const data = {
                Codigo: document.getElementById('productoCodigo').value,
                Nombre: document.getElementById('productoNombre').value,
                Descripcion: document.getElementById('productoDescripcion').value,
                Categoria: document.getElementById('productoCategoria').value,
                Unidad: document.getElementById('productoUnidad').value,
                Stock_Minimo: parseInt(document.getElementById('productoStockMinimo').value),
                Stock_Actual: parseInt(document.getElementById('productoStockActual').value)
            };

            const token = localStorage.getItem('token');
            const url = id ? `${API_URL}/productos/${id}` : `${API_URL}/productos/`;
            const method = id ? 'PUT' : 'POST';

            mostrarLoading(true);

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Error al guardar producto');
                }

                mostrarAlerta(result.message || 'Producto guardado exitosamente', 'success');
                modalProducto.hide();
                await cargarProductos();

            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta(error.message, 'danger');
            } finally {
                mostrarLoading(false);
            }
        }

        // Eliminar producto
        async function eliminarProducto(id) {
            if (!confirm('¿Estás seguro de eliminar este producto?')) return;

            const token = localStorage.getItem('token');
            mostrarLoading(true);

            try {
                const response = await fetch(`${API_URL}/productos/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Error al eliminar producto');
                }

                mostrarAlerta(result.message, 'success');
                await cargarProductos();

            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta(error.message, 'danger');
            } finally {
                mostrarLoading(false);
            }
        }

        // Ver detalle del producto
        function verDetalle(id) {
            const producto = productos.find(p => p.ID_Producto === id);
            if (!producto) return;

            alert(`
Detalles del Producto:
-----------------------
Código: ${producto.Codigo}
Nombre: ${producto.Nombre}
Descripción: ${producto.Descripcion || 'N/A'}
Categoría: ${producto.Categoria || 'N/A'}
Stock Actual: ${producto.Stock_Actual} ${producto.Unidad}
Stock Mínimo: ${producto.Stock_Minimo} ${producto.Unidad}
Estado: ${producto.Activo ? 'Activo' : 'Inactivo'}
            `);
        }

        // Verificar alertas de stock
        async function verificarAlertas() {
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch(`${API_URL}/productos/alertas`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const alertas = await response.json();
                const badge = document.getElementById('alertasBadge');
                
                if (alertas.length > 0) {
                    badge.textContent = alertas.length;
                    badge.style.display = 'inline';
                }
            } catch (error) {
                console.error('Error al cargar alertas:', error);
            }
        }

        // Ver alertas
        function verAlertas() {
            window.location.href = '/alertas';
        }

        // Limpiar filtros
        function limpiarFiltros() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filtroEstado').value = 'activo';
            document.getElementById('filtroCategoria').value = '';
            filtrarProductos();
        }

        // Cerrar sesión
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login';
        }

        // Mostrar loading
        function mostrarLoading(mostrar) {
            document.getElementById('overlay').style.display = mostrar ? 'block' : 'none';
            document.querySelector('.loading-spinner').style.display = mostrar ? 'block' : 'none';
        }

        // Mostrar alerta
        function mostrarAlerta(mensaje, tipo = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 10000; min-width: 300px;';
            alertDiv.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => alertDiv.remove(), 5000);
        }
    </script>
</body>
</html>